### E-Book2PDF 프로젝트 유지보수 문서 (v2.1)

이 문서는 미래의 Gemini 에이전트가 이 프로젝트의 컨텍스트를 빠르게 파악하고, 안정화된 현재 아키텍처를 이해하여 과거의 실수를 반복하지 않도록 돕기 위해 작성되었습니다.

---

### 1. 최종 아키텍처 (macOS Retina 최적화)

- **핵심 전략**: **논리적 좌표(Point)와 물리적 좌표(Pixel)의 불일치** 문제를 해결하는 것이 이 프로젝트의 가장 중요한 과제였습니다.
- **스케일 팩터 자동 감지**:
    - 앱 시작 시, `App` 클래스는 `Foundation.NSScreen.mainScreen().backingScaleFactor()`를 통해 현재 디스플레이의 스케일 팩터(예: Retina의 경우 `2.0`)를 자동으로 감지하여 `self.scale_factor`에 저장합니다.
- **좌표 캡처**:
    - 사용자의 모든 좌표 입력(`스크린샷 범위`, `클릭 위치`)은 `pyautogui.position()`을 통해 **논리적 좌표(Point)**로 캡처됩니다. 이 방식은 가장 단순하고 안정적입니다.
- **픽셀 좌표 변환**:
    - **이미지를 자르기 직전**(`show_preview`, `process_and_convert_to_pdf`)에, 저장된 논리 좌표에 `self.scale_factor`를 곱하여 **실제 물리적 픽셀 좌표**로 변환합니다.
    - `crop_box = (int(logical_x * scale), int(logical_y * scale), ...)`

이 **`감지 -> 논리 캡처 -> 픽셀 변환`** 방식이 현재의 가장 안정적이고 정확한 아키텍처입니다.

---

### 2. 주요 문제 해결의 역사

1.  **좌표 문제**: Retina 디스플레이에서 스크린샷 영역이 의도한 것보다 작게 잘리는 현상.
    - **해결**: 위 `1. 최종 아키텍처`에서 설명한 방식으로 해결. 네이티브 좌표를 직접 읽는 방식은 과하게 복잡하고 다른 문제를 야기하여 폐기함.

2.  **키 입력 문제**: `KeyPressPage`에서 키 입력이 안 되거나, 다른 페이지의 입력이 키 설정에 영향을 주는 현상.
    - **원인**: 이벤트 리스너의 생명주기 관리 실패. 다른 위젯의 입력 이벤트가 '유령 이벤트'로 남아 `KeyPressPage`의 리스너에 즉시 감지되는 문제 발생.
    - **해결**: **지연 바인딩(Lazy Binding)** 도입. `KeyPressPage`가 화면에 표시된 후, `after(100, ...)`를 사용해 0.1초 지연시킨 뒤 키보드 리스너를 활성화함. 이로써 유령 이벤트를 무시하고 사용자의 새 입력만 정확히 받게 됨. 키가 선택되면 리스너는 즉시 해제하여 다른 페이지에 영향을 주지 않도록 함.

3.  **권한 문제**: 잘 되던 앱이 갑자기 "권한을 확인하라"며 멈추는 현상.
    - **원인**: 코드 버그가 아닌, macOS의 권한 시스템 특성. 앱(터미널, VSCode 등)이 업데이트되면 macOS가 이를 새 앱으로 인식하여 기존 권한이 제대로 동작하지 않을 수 있음.
    - **해결**: `README.md`의 문제 해결 섹션에 안내된 대로, 시스템 설정에서 관련 권한을 완전히 제거했다가 다시 추가하는 '권한 재설정'이 유일하고 확실한 해결책임.

---

### 3. 핵심 개발 규칙

- **GUI 앱 실행 금지**: 이 프로젝트는 GUI 앱이므로, `run_shell_command`로 `python3 app.py`를 실행하지 말 것. (무한 로딩 발생)
- **스케일링 로직 유지**: 현재의 스케일 팩터 처리 방식은 macOS 환경의 핵심이므로, 임의로 다른 방식으로 회귀하지 말 것.
- **이벤트 리스너 주의**: Tkinter의 이벤트 처리는 복잡하므로, 리스너를 등록(`bind`)하고 해제(`unbind`)하는 시점을 명확히 관리해야 함. 필요하다면 '지연 바인딩'을 적극적으로 사용할 것.
- **이 문서(gemini.md)를 먼저 읽고 업데이트할 것**: 모든 작업 시작 전 이 문서를 읽어 컨텍스트를 파악하고, 작업 완료 후에는 변경된 내용이나 새로 발견한 문제점을 이 문서에 반드시 기록하여 연속성을 유지할 것.
